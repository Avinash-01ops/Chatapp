<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Socket.IO Chat</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      background: #111;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .chat-container {
      background: #111;
      box-shadow: none;
      border-radius: 0;
      max-width: 1100px;
      width: 100%;
      height: 80vh;
      display: flex;
      flex-direction: column;
      border: 1px solid #222;
    }
    .chat-header {
      padding: 12px 16px;
      background: #1a1a1a;
      border-bottom: 1px solid #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .active-users {
      font-size: 13px;
      color: #4fc3f7;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .online-dot {
      width: 8px;
      height: 8px;
      background: #4caf50;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    .reply-indicator {
      font-size: 10px;
      color: #4fc3f7;
      margin-bottom: 4px;
      padding: 2px 6px;
      background: #1a1a1a;
      border-left: 2px solid #4fc3f7;
      border-radius: 3px;
    }
    .ghost-panel {
      position: fixed;
      right: -260px;
      top: 0;
      width: 240px;
      height: 100vh;
      background: #000;
      border-left: 1px solid #222;
      transition: right 0.2s;
      z-index: 1000;
      overflow: hidden;
      font-family: 'Courier New', monospace;
    }
    .ghost-panel.active {
      right: 0;
    }
    .ghost-header {
      background: #111;
      padding: 8px 12px;
      border-bottom: 1px solid #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .ghost-header h3 {
      color: #afafaf;
      margin: 0;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .collapse-btn {
      background: none;
      border: none;
      color: #afafaf;
      cursor: pointer;
      font-size: 12px;
      opacity: 0.7;
    }
    .ghost-content {
      padding: 8px;
      height: calc(100vh - 35px);
      overflow-y: auto;
    }
    .user-info {
      background: #0a0a0a;
      padding: 6px;
      margin: 4px 0;
      border-radius: 2px;
      font-size: 10px;
      color: #999;
      border: 1px solid #222;
    }
    .user-info .username {
      color: #fff;
      font-weight: normal;
      margin-bottom: 4px;
      font-size: 11px;
    }
    .info-row {
      margin: 1px 0;
      display: flex;
      justify-content: space-between;
    }
    .info-label {
      color: #555;
      width: 50px;
    }
    .ghost-toggle {
      position: fixed;
      left: 3px;
      bottom: 15px;
      background: transparent;
      border: 1px solid #333;
      color: #666;
      padding: 2px 4px;
      border-radius: 1px;
      cursor: pointer;
      z-index: 999;
      font-size: 7px;
      opacity: 0.2;
      transition: opacity 0.2s;
      font-family: 'Courier New', monospace;
    }
    .ghost-toggle:hover {
      opacity: 0.6;
    }
    .messages-container {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px 10px;
      font-size: 16px;
    }
    .message-container {
      margin-bottom: 18px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      position: relative;
    }
    .sender-message-container {
      align-items: flex-end;
    }
    .username {
      font-size: 13px;
      color: #bbb;
      margin-bottom: 2px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    .message-bubble {
      background: #222;
      color: #fff;
      padding: 10px 16px;
      border-radius: 8px;
      max-width: 80%;
      word-break: break-word;
      font-size: 16px;
      margin-bottom: 2px;
      box-shadow: none;
      border: none;
      position: relative;
      min-height: 32px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .message-bubble img.chat-image {
      max-width: 220px;
      max-height: 220px;
      border-radius: 10px;
      display: block;
      margin: 4px 0;
    }
    .message-bubble .big-emoji {
      font-size: 48px;
      line-height: 1.2;
      display: block;
      margin: 4px 0;
    }

    .timestamp {
      font-size: 11px;
      color: #666;
      margin-top: 2px;
      text-align: right;
      align-self: flex-end;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .read-receipt {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #666;
      display: inline-block;
    }
    .read-receipt.read {
      background: #4caf50;
      box-shadow: 0 0 4px #4caf50;
    }
    .message-input-container {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: #111;
      border-top: 1px solid #222;
    }
    #messageInput {
      flex-grow: 1;
      border: 1px solid #333;
      outline: none;
      border-radius: 6px;
      height: 38px;
      font-size: 15px;
      padding: 0 12px;
      background: #222;
      color: #fff;
      box-sizing: border-box;
    }
    #messageInput:focus {
      border-color: #555;
    }
    #sendButton, #clearChatButton {
      background: #222;
      color: #fff;
      border: none;
      border-radius: 6px;
      height: 38px;
      width: 80px;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #sendButton:hover, #clearChatButton:hover {
      background: #333;
    }
    #emojiButton {
      font-size: 28px;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      margin-left: 4px;
      transition: transform 0.2s;
    }
    #emojiButton:hover {
      transform: scale(1.2) rotate(-10deg);
    }
    #emojiPickerContainer {
      position: absolute;
      bottom: 60px;
      left: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px;
      background: #222;
      border: 1px solid #333;
      border-radius: 8px;
      z-index: 100;
      max-width: 400px;
      max-height: 220px;
      overflow-y: auto;
    }
    #emojiPickerContainer.hidden {
      display: none;
    }
    #emojiPickerContainer span {
      cursor: pointer;
      font-size: 32px;
      padding: 6px;
      border-radius: 6px;
      transition: background 0.2s, transform 0.2s;
      display: inline-block;
    }
    #emojiPickerContainer span:hover {
      background: #333;
      transform: scale(1.3) rotate(-10deg);
    }
    .reaction-btn {
      background: none;
      border: none;
      color: #888;
      font-size: 12px;
      cursor: pointer;
      padding: 2px;
      transition: all 0.2s;
      border-radius: 3px;
    }
    .reaction-btn:hover {
      background: #333;
      color: #fff;
    }
    .reactions-bar {
      display: flex;
      gap: 4px;
      margin-top: 4px;
      margin-left: 2px;
    }
    .reaction-emoji {
      font-size: 26px;
      background: #222;
      border-radius: 6px;
      padding: 2px 6px;
      margin-right: 2px;
      transition: transform 0.2s;
      display: inline-block;
      border: 1px solid #333;
    }
    .reaction-emoji:hover {
      transform: scale(1.2) rotate(-10deg);
      background: #333;
    }
    .reaction-picker {
      position: absolute;
      top: 30px;
      left: 0;
      background: #222;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      z-index: 200;
    }
    .reaction-picker span {
      font-size: 28px;
      cursor: pointer;
      padding: 4px;
      border-radius: 5px;
      transition: background 0.2s, transform 0.2s;
    }
    .reaction-picker span:hover {
      background: #333;
      transform: scale(1.2) rotate(-10deg);
    }
    .modal {
      display: none;
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(20, 20, 20, 0.85);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #222;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      width: 350px;
      color: #fff;
      box-shadow: none;
    }
    .modal-content input, .modal-content button {
      width: 90%;
      height: 38px;
      margin-top: 18px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #111;
      color: #fff;
      font-size: 15px;
      box-sizing: border-box;
    }
    .modal-content button {
      background: #333;
      cursor: pointer;
      border: none;
    }
    .modal-content button:hover {
      background: #444;
    }
  </style>
</head>
<body>
    <!-- Username modal -->
    <div id="usernameModal" class="modal">
        <div class="modal-content">
            <h2>Enter Your Username</h2>
            <input type="text" id="usernameInput" placeholder="Enter username..." />
            <input type="password" id="secretCodeInput" placeholder="Access code..." style="display: none;" />
            <button id="usernameSubmitButton">Submit</button>
        </div>
    </div>

    <!-- Ghost Panel -->
    <div id="ghostPanel" class="ghost-panel">
        <div class="ghost-header">
            <h3>SURVEILLANCE</h3>
            <button class="collapse-btn" id="collapseBtn">×</button>
        </div>
        <div class="ghost-content">
            <div id="usersList"></div>
        </div>
    </div>
    <button id="ghostToggle" class="ghost-toggle" style="display: none;">SYS</button>

    <div class="chat-container">
      <div class="chat-header">
        <div class="active-users">
          <div class="online-dot"></div>
          <span id="activeCount">1 active</span>
        </div>
      </div>
      <div class="messages-container" id="messages"></div>
      <div class="message-input-container">
        <input type="text" id="messageInput" placeholder="Type a message...">
        <button id="emojiButton" title="Add Emoji">😊</button>
        <div id="emojiPickerContainer" class="hidden">
          <div id="emojiPicker">
            <span>😀</span><span>😂</span><span>❤️</span><span>👍</span><span>🎉</span><span>😊</span>
            <span>🤔</span><span>🥳</span><span>🙌</span><span>😎</span><span>🙏</span><span>🤩</span>
            <span>🔥</span><span>🥰</span><span>😱</span><span>😜</span><span>😇</span><span>💯</span>
            <span>😅</span><span>😏</span><span>😤</span><span>😬</span><span>😋</span><span>😢</span>
            <span>😡</span><span>😆</span><span>😃</span><span>😄</span><span>😚</span><span>😙</span>
            <span>😗</span><span>😽</span><span>😺</span><span>😸</span><span>😻</span><span>😼</span>
            <span>😹</span><span>🥹</span><span>🫶</span><span>🤗</span><span>😇</span><span>😋</span>
            <span>😛</span><span>😝</span><span>😜</span><span>🤪</span><span>🤤</span><span>😪</span>
            <span>😴</span><span>😷</span><span>🤒</span><span>🤕</span><span>🤑</span><span>🤠</span>
          </div>
        </div>

        <button id="sendButton">Send</button>
        <button id="clearChatButton">Clear</button>
      </div>
    </div>
  
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const usernameModal = document.getElementById('usernameModal');
        const usernameInput = document.getElementById('usernameInput');
        const usernameSubmitButton = document.getElementById('usernameSubmitButton');
        const secretCodeInput = document.getElementById('secretCodeInput');
        const clearChatButton = document.getElementById('clearChatButton');
        const emojiButton = document.getElementById('emojiButton');
        const emojiPickerContainer = document.getElementById('emojiPickerContainer');
        const activeCountElement = document.getElementById('activeCount');
        const ghostPanel = document.getElementById('ghostPanel');
        const usersList = document.getElementById('usersList');
        const ghostToggle = document.getElementById('ghostToggle');
        const collapseBtn = document.getElementById('collapseBtn');


        // Use Socket.IO for real-time communication
        const socket = io();

        let username = '';
        let reactionPickers = [];
        let activeUsers = 0;
        let messageReadStatus = new Map();
        let replyingTo = null;
        let connectedUsers = new Map();
        let isGhostMode = false;
        let ghostAuthenticated = false;

        // Show modal to set username when the page loads
        window.addEventListener('load', () => {
            usernameModal.style.display = 'flex';
        });

        // Handle username submission
        function submitUsername() {
            const input = usernameInput.value.trim();
            if (!input) {
                alert('Please enter a username.');
                return;
            }
            
            if (input === 'ghost') {
                const authCode = secretCodeInput.value.trim();
                if (authCode !== 'bravosix') {
                    alert('Access denied.');
                    secretCodeInput.value = '';
                    secretCodeInput.focus();
                    return;
                }
                ghostAuthenticated = true;
                isGhostMode = true;
            }
            
            username = input;
            usernameModal.style.display = 'none';
            
            const clientInfo = {
                username,
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                screenResolution: `${screen.width}x${screen.height}`,
                colorDepth: screen.colorDepth,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                cookieEnabled: navigator.cookieEnabled,
                onlineStatus: navigator.onLine,
                connection: navigator.connection ? {
                    effectiveType: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink
                } : null
            };
            
            socket.emit('user joined', clientInfo);
            
            if (isGhostMode && ghostAuthenticated) {
                ghostPanel.classList.add('active');
                ghostToggle.style.display = 'block';
            }
        }
        
        usernameSubmitButton.addEventListener('click', submitUsername);
        usernameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (usernameInput.value.trim() === 'ghost' && secretCodeInput.style.display === 'none') {
                    secretCodeInput.style.display = 'block';
                    secretCodeInput.focus();
                } else {
                    submitUsername();
                }
            }
        });
        
        usernameInput.addEventListener('input', (e) => {
            if (e.target.value.trim() === 'ghost') {
                secretCodeInput.style.display = 'block';
            } else {
                secretCodeInput.style.display = 'none';
            }
        });
        
        secretCodeInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                submitUsername();
            }
        });

        // Handle receiving messages from the server
        socket.on('chat message', (data) => {
            const { username: sender, message, image, reactions, timestamp, id, replyTo } = data;
            if (sender !== username) {
                displayMessage(sender, message, false, image, null, reactions, timestamp, id, false, replyTo);
            }
        });

        // Handle receiving reactions
        socket.on('reaction', ({ messageId, emoji }) => {
            const msgDiv = document.querySelector(`[data-id="${messageId}"]`);
            if (msgDiv) {
                addReactionToMessage(msgDiv, emoji);
            }
        });

        // Handle active users count
        socket.on('active users', ({ count, users }) => {
            activeUsers = count;
            activeCountElement.textContent = `${count} active`;
            connectedUsers = new Map(users);
            if (isGhostMode && ghostAuthenticated) {
                updateGhostPanel();
            }
        });

        // Handle message read receipts
        socket.on('message read', ({ messageId }) => {
            const msgDiv = document.querySelector(`[data-id="${messageId}"]`);
            if (msgDiv && msgDiv.classList.contains('sender-message-container')) {
                const receipt = msgDiv.querySelector('.read-receipt');
                if (receipt) {
                    receipt.classList.add('read');
                }
            }
        });

        // Mark messages as read when they come into view
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const messageId = entry.target.dataset.id;
                    if (messageId && !entry.target.classList.contains('sender-message-container')) {
                        socket.emit('mark read', { messageId });
                    }
                }
            });
        }, { threshold: 0.5 });

        // Handle sending messages
        function sendMessage({image} = {}) {
            let message = messageInput.value.trim();
            if (!username) {
                alert('Please enter a username before sending messages.');
                return;
            }
            // If user only sends a single emoji, treat as big emoji
            let isBigEmoji = false;
            if (!image && message && /^([\uD800-\uDBFF][\uDC00-\uDFFF]|\p{Emoji_Presentation}|\p{Extended_Pictographic})$/u.test(message)) {
                isBigEmoji = true;
            }
            if (!message && !image) {
                messageInput.placeholder = 'Enter a message';
                messageInput.style.border = '2px crimson solid';
                messageInput.style.color = 'red';
                messageInput.addEventListener('input', () => {
                    messageInput.placeholder = 'Type a message...';
                    messageInput.style.border = '1px solid #333';
                    messageInput.style.color = '#fff';
                }, { once: true });
                return;
            }
            const msgObj = {
                username,
                message,
                image: image || null,
                reactions: [],
                timestamp: Date.now(),
                id: Date.now().toString() + Math.random().toString(36).slice(2),
                isBigEmoji,
                replyTo: replyingTo
            };
            socket.emit('chat message', msgObj);
            displayMessage(username, message, true, image, null, [], msgObj.timestamp, msgObj.id, isBigEmoji, replyingTo);
            messageInput.value = '';
            messageReadStatus.set(msgObj.id, false);
            replyingTo = null;
        }

        sendButton.addEventListener('click', () => sendMessage());

        // Send message on Enter key
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                sendMessage();
            }
        });

        // Emoji picker for message input
        emojiButton.addEventListener('click', () => {
          emojiPickerContainer.classList.toggle('hidden');
        });

        emojiPickerContainer.addEventListener('click', (event) => {
          if (event.target.tagName === 'SPAN') {
            // If user picks a single emoji, send as big emoji
            messageInput.value = event.target.textContent;
            emojiPickerContainer.classList.add('hidden');
            sendMessage();
          }
        });

        // Paste image URL or image data
        messageInput.addEventListener('paste', (e) => {
            const items = (e.clipboardData || window.clipboardData).items;
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.type.indexOf("image") !== -1) {
                    const file = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(evt) {
                        sendMessage({image: evt.target.result});
                    };
                    reader.readAsDataURL(file);
                    e.preventDefault();
                    return;
                }
            }
            // If not image, check for image URL
            const text = (e.clipboardData || window.clipboardData).getData('text');
            if (text && (text.startsWith('http://') || text.startsWith('https://')) && /\.(jpg|jpeg|png|gif|webp)$/i.test(text)) {
                sendMessage({image: text});
                e.preventDefault();
            }
        });



        // Display a message with username above, timestamp below, reactions, and reaction button
        function displayMessage(sender, message, isSender = false, image = null, sticker = null, reactions = [], timestamp = null, id = null, isBigEmoji = false, replyTo = null) {
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('message-container');
            if (isSender) messageContainer.classList.add('sender-message-container');
            const messageId = id || Date.now().toString() + Math.random().toString(36).slice(2);
            messageContainer.dataset.id = messageId;

            const usernameElement = document.createElement('div');
            usernameElement.textContent = sender;
            usernameElement.classList.add('username');
            
            // Add reply indicator
            if (replyTo) {
                const replyDiv = document.createElement('div');
                replyDiv.className = 'reply-indicator';
                replyDiv.textContent = `↳ ${replyTo.username}: ${replyTo.message?.substring(0, 30) || 'media'}...`;
                messageContainer.appendChild(replyDiv);
            }

            const messageElement = document.createElement('div');
            messageElement.classList.add('message-bubble');

            // Add text or big emoji
            if (message) {
                if (isBigEmoji) {
                    const emojiSpan = document.createElement('span');
                    emojiSpan.textContent = message;
                    emojiSpan.className = 'big-emoji';
                    messageElement.appendChild(emojiSpan);
                } else {
                    const textNode = document.createElement('span');
                    textNode.textContent = message;
                    messageElement.appendChild(textNode);
                }
            }
            // Add image
            if (image) {
                const img = document.createElement('img');
                img.src = image;
                img.alt = "sent image";
                img.className = "chat-image";
                messageElement.appendChild(img);
            }


            // Reaction bar
            const reactionsBar = document.createElement('div');
            reactionsBar.className = 'reactions-bar';
            if (Array.isArray(reactions)) {
                reactions.forEach(emoji => {
                    const emojiSpan = document.createElement('span');
                    emojiSpan.className = 'reaction-emoji';
                    emojiSpan.textContent = emoji;
                    reactionsBar.appendChild(emojiSpan);
                });
            }

            // Reaction and reply buttons
            const reactBtn = document.createElement('button');
            reactBtn.className = 'reaction-btn';
            reactBtn.title = 'React';
            reactBtn.innerHTML = '✌️';
            
            const replyBtn = document.createElement('button');
            replyBtn.className = 'reaction-btn';
            replyBtn.title = 'Reply';
            replyBtn.innerHTML = '➡️';
            replyBtn.addEventListener('click', () => {
                replyingTo = { username: sender, message, id: messageId };
                messageInput.placeholder = `Replying to ${sender}...`;
                messageInput.focus();
            });

            // Reaction picker
            let pickerDiv = null;
            reactBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                closeAllReactionPickers();
                pickerDiv = createReactionPicker((emoji) => {
                    addReactionToMessage(messageContainer, emoji);
                    socket.emit('reaction', { messageId, emoji });
                    pickerDiv.remove();
                });
                messageContainer.appendChild(pickerDiv);
                reactionPickers.push(pickerDiv);
            });

            // Close picker if clicking outside
            document.addEventListener('click', closeAllReactionPickers);

            function closeAllReactionPickers() {
                reactionPickers.forEach(p => p.remove());
                reactionPickers = [];
            }

            messageElement.appendChild(reactionsBar);

            const timestampElement = document.createElement('div');
            timestampElement.classList.add('timestamp');
            
            timestampElement.appendChild(reactBtn);
            timestampElement.appendChild(replyBtn);
            
            const timeSpan = document.createElement('span');
            timeSpan.textContent = formatTimestamp(timestamp ? new Date(timestamp) : new Date());
            timestampElement.appendChild(timeSpan);
            
            // Add read receipt for sender's messages
            if (isSender) {
                const receipt = document.createElement('div');
                receipt.className = 'read-receipt';
                timestampElement.appendChild(receipt);
            }

            messageContainer.appendChild(usernameElement);
            messageContainer.appendChild(messageElement);
            messageContainer.appendChild(timestampElement);

            messagesDiv.appendChild(messageContainer);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Observe message for read receipts
            if (messageId) {
                observer.observe(messageContainer);
            }
        }

        function addReactionToMessage(msgDiv, emoji) {
            const bar = msgDiv.querySelector('.reactions-bar');
            if (bar) {
                // Only add if not already present (or you can allow duplicates)
                if (![...bar.children].some(e => e.textContent === emoji)) {
                    const emojiSpan = document.createElement('span');
                    emojiSpan.className = 'reaction-emoji';
                    emojiSpan.textContent = emoji;
                    bar.appendChild(emojiSpan);
                }
            }
        }

        function createReactionPicker(onSelect) {
            const picker = document.createElement('div');
            picker.className = 'reaction-picker';
            const emojis = [
                "😀","😂","😍","😎","😅","😇","🥳","🤩","😜","😢","😡","😱","👍","🙏","🔥","🎉","❤️","💯","😏","😬","😋","😤","😆","😃","😄","😚","😙","😗","😽","😺","😸","😻","😼","😹"
            ];
            emojis.forEach(emoji => {
                const span = document.createElement('span');
                span.textContent = emoji;
                span.addEventListener('click', (e) => {
                    e.stopPropagation();
                    onSelect(emoji);
                });
                picker.appendChild(span);
            });
            return picker;
        }

        function formatTimestamp(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        clearChatButton.addEventListener('click', () => {
          messagesDiv.innerHTML = '';
        });
        
        // Ghost mode functions
        function updateGhostPanel() {
            if (!isGhostMode || !ghostAuthenticated) return;
            
            usersList.innerHTML = '';
            connectedUsers.forEach((userData, socketId) => {
                const userDiv = document.createElement('div');
                userDiv.className = 'user-info';
                
                const browser = getBrowserInfo(userData.userAgent);
                const os = getOSInfo(userData.userAgent);
                const device = getDeviceType(userData.userAgent);
                
                userDiv.innerHTML = `
                    <div class="username">${userData.username}</div>
                    <div class="info-row"><span class="info-label">IP</span> ${userData.ip}</div>
                    <div class="info-row"><span class="info-label">LOC</span> ${userData.location}</div>
                    <div class="info-row"><span class="info-label">OS</span> ${os}</div>
                    <div class="info-row"><span class="info-label">DEV</span> ${device}</div>
                    <div class="info-row"><span class="info-label">RES</span> ${userData.screenResolution}</div>
                    <div class="info-row"><span class="info-label">TZ</span> ${userData.timezone}</div>
                    <div class="info-row"><span class="info-label">CONN</span> ${userData.connection?.effectiveType || 'UNK'}</div>
                    <div class="info-row"><span class="info-label">TIME</span> ${new Date(userData.joinTime).toLocaleTimeString()}</div>
                `;
                usersList.appendChild(userDiv);
            });
        }
        
        function getBrowserInfo(userAgent) {
            if (userAgent.includes('Chrome')) return 'CHR';
            if (userAgent.includes('Firefox')) return 'FF';
            if (userAgent.includes('Safari')) return 'SAF';
            if (userAgent.includes('Edge')) return 'EDG';
            return 'UNK';
        }
        
        function getOSInfo(userAgent) {
            if (userAgent.includes('Windows')) return 'WIN';
            if (userAgent.includes('Mac')) return 'MAC';
            if (userAgent.includes('Linux')) return 'LNX';
            if (userAgent.includes('Android')) return 'AND';
            if (userAgent.includes('iOS')) return 'IOS';
            return 'UNK';
        }
        
        function getDeviceType(userAgent) {
            if (userAgent.includes('Mobile')) return 'MOB';
            if (userAgent.includes('Tablet')) return 'TAB';
            return 'DSK';
        }
        
        // Ghost panel controls
        collapseBtn.addEventListener('click', () => {
            ghostPanel.classList.remove('active');
            ghostToggle.style.display = 'block';
        });
        
        ghostToggle.addEventListener('click', () => {
            ghostPanel.classList.add('active');
            ghostToggle.style.display = 'none';
        });
        
        // Clear reply on Escape
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && replyingTo) {
                replyingTo = null;
                messageInput.placeholder = 'Type a message...';
            }
        });
        
        // Secret access - Ctrl+Shift+G
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'G' && isGhostMode && ghostAuthenticated) {
                if (ghostPanel.classList.contains('active')) {
                    ghostPanel.classList.remove('active');
                    ghostToggle.style.display = 'block';
                } else {
                    ghostPanel.classList.add('active');
                    ghostToggle.style.display = 'none';
                }
            }
        });
    </script>
</body>
</html>
