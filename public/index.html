<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Socket.IO Chat</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      background: #111;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .chat-container {
      background: #111;
      box-shadow: none;
      border-radius: 0;
      max-width: 1100px;
      width: 100%;
      height: 80vh;
      display: flex;
      flex-direction: column;
      border: 1px solid #222;
    }
    .messages-container {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px 10px;
      font-size: 16px;
    }
    .message-container {
      margin-bottom: 18px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      position: relative;
    }
    .sender-message-container {
      align-items: flex-end;
    }
    .username {
      font-size: 13px;
      color: #bbb;
      margin-bottom: 2px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    .message-bubble {
      background: #222;
      color: #fff;
      padding: 10px 16px;
      border-radius: 8px;
      max-width: 80%;
      word-break: break-word;
      font-size: 16px;
      margin-bottom: 2px;
      box-shadow: none;
      border: none;
      position: relative;
      min-height: 32px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .message-bubble img.chat-image {
      max-width: 220px;
      max-height: 220px;
      border-radius: 10px;
      display: block;
      margin: 4px 0;
    }
    .message-bubble .big-emoji {
      font-size: 48px;
      line-height: 1.2;
      display: block;
      margin: 4px 0;
    }

    .timestamp {
      font-size: 11px;
      color: #666;
      margin-top: 2px;
      text-align: right;
      align-self: flex-end;
    }
    .message-input-container {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: #111;
      border-top: 1px solid #222;
    }
    #messageInput {
      flex-grow: 1;
      border: 1px solid #333;
      outline: none;
      border-radius: 6px;
      height: 38px;
      font-size: 15px;
      padding: 0 12px;
      background: #222;
      color: #fff;
      box-sizing: border-box;
    }
    #messageInput:focus {
      border-color: #555;
    }
    #sendButton, #clearChatButton {
      background: #222;
      color: #fff;
      border: none;
      border-radius: 6px;
      height: 38px;
      width: 80px;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #sendButton:hover, #clearChatButton:hover {
      background: #333;
    }
    #emojiButton {
      font-size: 28px;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      margin-left: 4px;
      transition: transform 0.2s;
    }
    #emojiButton:hover {
      transform: scale(1.2) rotate(-10deg);
    }
    #emojiPickerContainer {
      position: absolute;
      bottom: 60px;
      left: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px;
      background: #222;
      border: 1px solid #333;
      border-radius: 8px;
      z-index: 100;
      max-width: 400px;
      max-height: 220px;
      overflow-y: auto;
    }
    #emojiPickerContainer.hidden {
      display: none;
    }
    #emojiPickerContainer span {
      cursor: pointer;
      font-size: 32px;
      padding: 6px;
      border-radius: 6px;
      transition: background 0.2s, transform 0.2s;
      display: inline-block;
    }
    #emojiPickerContainer span:hover {
      background: #333;
      transform: scale(1.3) rotate(-10deg);
    }
    .reaction-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      margin-left: 6px;
      margin-top: 2px;
      transition: transform 0.2s;
    }
    .reaction-btn:hover {
      transform: scale(1.2) rotate(-10deg);
    }
    .reactions-bar {
      display: flex;
      gap: 4px;
      margin-top: 4px;
      margin-left: 2px;
    }
    .reaction-emoji {
      font-size: 26px;
      background: #222;
      border-radius: 6px;
      padding: 2px 6px;
      margin-right: 2px;
      transition: transform 0.2s;
      display: inline-block;
      border: 1px solid #333;
    }
    .reaction-emoji:hover {
      transform: scale(1.2) rotate(-10deg);
      background: #333;
    }
    .reaction-picker {
      position: absolute;
      top: 30px;
      left: 0;
      background: #222;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      z-index: 200;
    }
    .reaction-picker span {
      font-size: 28px;
      cursor: pointer;
      padding: 4px;
      border-radius: 5px;
      transition: background 0.2s, transform 0.2s;
    }
    .reaction-picker span:hover {
      background: #333;
      transform: scale(1.2) rotate(-10deg);
    }
    .modal {
      display: none;
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(20, 20, 20, 0.85);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #222;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      width: 350px;
      color: #fff;
      box-shadow: none;
    }
    .modal-content input, .modal-content button {
      width: 90%;
      height: 38px;
      margin-top: 18px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #111;
      color: #fff;
      font-size: 15px;
      box-sizing: border-box;
    }
    .modal-content button {
      background: #333;
      cursor: pointer;
      border: none;
    }
    .modal-content button:hover {
      background: #444;
    }
  </style>
</head>
<body>
    <!-- Username modal -->
    <div id="usernameModal" class="modal">
        <div class="modal-content">
            <h2>Enter Your Username</h2>
            <input type="text" id="usernameInput" placeholder="Enter username..." />
            <button id="usernameSubmitButton">Submit</button>
        </div>
    </div>

    <div class="chat-container">
      <div class="messages-container" id="messages"></div>
      <div class="message-input-container">
        <input type="text" id="messageInput" placeholder="Type a message...">
        <button id="emojiButton" title="Add Emoji">😊</button>
        <div id="emojiPickerContainer" class="hidden">
          <div id="emojiPicker">
            <span>😀</span><span>😂</span><span>❤️</span><span>👍</span><span>🎉</span><span>😊</span>
            <span>🤔</span><span>🥳</span><span>🙌</span><span>😎</span><span>🙏</span><span>🤩</span>
            <span>🔥</span><span>🥰</span><span>😱</span><span>😜</span><span>😇</span><span>💯</span>
            <span>😅</span><span>😏</span><span>😤</span><span>😬</span><span>😋</span><span>😢</span>
            <span>😡</span><span>😆</span><span>😃</span><span>😄</span><span>😚</span><span>😙</span>
            <span>😗</span><span>😽</span><span>😺</span><span>😸</span><span>😻</span><span>😼</span>
            <span>😹</span><span>🥹</span><span>🫶</span><span>🤗</span><span>😇</span><span>😋</span>
            <span>😛</span><span>😝</span><span>😜</span><span>🤪</span><span>🤤</span><span>😪</span>
            <span>😴</span><span>😷</span><span>🤒</span><span>🤕</span><span>🤑</span><span>🤠</span>
          </div>
        </div>

        <button id="sendButton">Send</button>
        <button id="clearChatButton">Clear</button>
      </div>
    </div>
  
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const usernameModal = document.getElementById('usernameModal');
        const usernameInput = document.getElementById('usernameInput');
        const usernameSubmitButton = document.getElementById('usernameSubmitButton');
        const clearChatButton = document.getElementById('clearChatButton');
        const emojiButton = document.getElementById('emojiButton');
        const emojiPickerContainer = document.getElementById('emojiPickerContainer');


        // Use Socket.IO for real-time communication
        const socket = io();

        let username = '';
        let reactionPickers = [];

        // Show modal to set username when the page loads
        window.addEventListener('load', () => {
            usernameModal.style.display = 'flex';
        });

        // Handle username submission
        usernameSubmitButton.addEventListener('click', () => {
            const input = usernameInput.value.trim();
            if (!input) {
                alert('Please enter a username.');
                return;
            }
            username = input;
            usernameModal.style.display = 'none';
        });

        // Handle receiving messages from the server
        socket.on('chat message', (data) => {
            const { username: sender, message, image, reactions, timestamp } = data;
            if (sender !== username) {
                displayMessage(sender, message, false, image, null, reactions, timestamp);
            }
        });

        // Handle receiving reactions
        socket.on('reaction', ({ messageId, emoji }) => {
            const msgDiv = document.querySelector(`[data-id="${messageId}"]`);
            if (msgDiv) {
                addReactionToMessage(msgDiv, emoji);
            }
        });

        // Handle sending messages
        function sendMessage({image} = {}) {
            let message = messageInput.value.trim();
            if (!username) {
                alert('Please enter a username before sending messages.');
                return;
            }
            // If user only sends a single emoji, treat as big emoji
            let isBigEmoji = false;
            if (!image && message && /^([\uD800-\uDBFF][\uDC00-\uDFFF]|\p{Emoji_Presentation}|\p{Extended_Pictographic})$/u.test(message)) {
                isBigEmoji = true;
            }
            if (!message && !image) {
                messageInput.placeholder = 'Enter a message';
                messageInput.style.border = '2px crimson solid';
                messageInput.style.color = 'red';
                messageInput.addEventListener('input', () => {
                    messageInput.placeholder = 'Type a message...';
                    messageInput.style.border = '1px solid #333';
                    messageInput.style.color = '#fff';
                }, { once: true });
                return;
            }
            const msgObj = {
                username,
                message,
                image: image || null,
                reactions: [],
                timestamp: Date.now(),
                id: Date.now().toString() + Math.random().toString(36).slice(2),
                isBigEmoji
            };
            socket.emit('chat message', msgObj);
            displayMessage(username, message, true, image, null, [], msgObj.timestamp, msgObj.id, isBigEmoji);
            messageInput.value = '';
        }

        sendButton.addEventListener('click', () => sendMessage());

        // Send message on Enter key
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Emoji picker for message input
        emojiButton.addEventListener('click', () => {
          emojiPickerContainer.classList.toggle('hidden');
        });

        emojiPickerContainer.addEventListener('click', (event) => {
          if (event.target.tagName === 'SPAN') {
            // If user picks a single emoji, send as big emoji
            messageInput.value = event.target.textContent;
            emojiPickerContainer.classList.add('hidden');
            sendMessage();
          }
        });

        // Paste image URL or image data
        messageInput.addEventListener('paste', (e) => {
            const items = (e.clipboardData || window.clipboardData).items;
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.type.indexOf("image") !== -1) {
                    const file = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(evt) {
                        sendMessage({image: evt.target.result});
                    };
                    reader.readAsDataURL(file);
                    e.preventDefault();
                    return;
                }
            }
            // If not image, check for image URL
            const text = (e.clipboardData || window.clipboardData).getData('text');
            if (text && (text.startsWith('http://') || text.startsWith('https://')) && /\.(jpg|jpeg|png|gif|webp)$/i.test(text)) {
                sendMessage({image: text});
                e.preventDefault();
            }
        });



        // Display a message with username above, timestamp below, reactions, and reaction button
        function displayMessage(sender, message, isSender = false, image = null, sticker = null, reactions = [], timestamp = null, id = null, isBigEmoji = false) {
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('message-container');
            if (isSender) messageContainer.classList.add('sender-message-container');
            const messageId = id || Date.now().toString() + Math.random().toString(36).slice(2);
            messageContainer.dataset.id = messageId;

            const usernameElement = document.createElement('div');
            usernameElement.textContent = sender;
            usernameElement.classList.add('username');

            const messageElement = document.createElement('div');
            messageElement.classList.add('message-bubble');

            // Add text or big emoji
            if (message) {
                if (isBigEmoji) {
                    const emojiSpan = document.createElement('span');
                    emojiSpan.textContent = message;
                    emojiSpan.className = 'big-emoji';
                    messageElement.appendChild(emojiSpan);
                } else {
                    const textNode = document.createElement('span');
                    textNode.textContent = message;
                    messageElement.appendChild(textNode);
                }
            }
            // Add image
            if (image) {
                const img = document.createElement('img');
                img.src = image;
                img.alt = "sent image";
                img.className = "chat-image";
                messageElement.appendChild(img);
            }


            // Reaction bar
            const reactionsBar = document.createElement('div');
            reactionsBar.className = 'reactions-bar';
            if (Array.isArray(reactions)) {
                reactions.forEach(emoji => {
                    const emojiSpan = document.createElement('span');
                    emojiSpan.className = 'reaction-emoji';
                    emojiSpan.textContent = emoji;
                    reactionsBar.appendChild(emojiSpan);
                });
            }

            // Reaction button
            const reactBtn = document.createElement('button');
            reactBtn.className = 'reaction-btn';
            reactBtn.title = 'React';
            reactBtn.innerHTML = '✌️';

            // Reaction picker
            let pickerDiv = null;
            reactBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                closeAllReactionPickers();
                pickerDiv = createReactionPicker((emoji) => {
                    addReactionToMessage(messageContainer, emoji);
                    socket.emit('reaction', { messageId, emoji });
                    pickerDiv.remove();
                });
                messageContainer.appendChild(pickerDiv);
                reactionPickers.push(pickerDiv);
            });

            // Close picker if clicking outside
            document.addEventListener('click', closeAllReactionPickers);

            function closeAllReactionPickers() {
                reactionPickers.forEach(p => p.remove());
                reactionPickers = [];
            }

            messageElement.appendChild(reactionsBar);
            messageElement.appendChild(reactBtn);

            const timestampElement = document.createElement('div');
            timestampElement.textContent = formatTimestamp(timestamp ? new Date(timestamp) : new Date());
            timestampElement.classList.add('timestamp');

            messageContainer.appendChild(usernameElement);
            messageContainer.appendChild(messageElement);
            messageContainer.appendChild(timestampElement);

            messagesDiv.appendChild(messageContainer);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addReactionToMessage(msgDiv, emoji) {
            const bar = msgDiv.querySelector('.reactions-bar');
            if (bar) {
                // Only add if not already present (or you can allow duplicates)
                if (![...bar.children].some(e => e.textContent === emoji)) {
                    const emojiSpan = document.createElement('span');
                    emojiSpan.className = 'reaction-emoji';
                    emojiSpan.textContent = emoji;
                    bar.appendChild(emojiSpan);
                }
            }
        }

        function createReactionPicker(onSelect) {
            const picker = document.createElement('div');
            picker.className = 'reaction-picker';
            const emojis = [
                "😀","😂","😍","😎","😅","😇","🥳","🤩","😜","😢","😡","😱","👍","🙏","🔥","🎉","❤️","💯","😏","😬","😋","😤","😆","😃","😄","😚","😙","😗","😽","😺","😸","😻","😼","😹"
            ];
            emojis.forEach(emoji => {
                const span = document.createElement('span');
                span.textContent = emoji;
                span.addEventListener('click', (e) => {
                    e.stopPropagation();
                    onSelect(emoji);
                });
                picker.appendChild(span);
            });
            return picker;
        }

        function formatTimestamp(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        clearChatButton.addEventListener('click', () => {
          messagesDiv.innerHTML = '';
        });
    </script>
</body>
</html>
